
Процедура КнопкаСформироватьНажатие(Кнопка)
	ТабДок = ЭлементыФормы.ПолеТабДок;
	
	Макет = Отчеты.ЛиквидацияСклада.ПолучитьМакет("Макет");	
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовокОсновное = Макет.ПолучитьОбласть("ЗаголовокОсновное");
	ОбластьЗаголовокСклад = Макет.ПолучитьОбласть("ЗаголовокСклад");
	ОбластьЗаголовокИтого = Макет.ПолучитьОбласть("ЗаголовокИтого");

	ОбластьДанныеОсновное = Макет.ПолучитьОбласть("ДанныеОсновное");
	ОбластьДанныеСклад = Макет.ПолучитьОбласть("ДанныеСклад");
	ОбластьДанныеИтого = Макет.ПолучитьОбласть("ДанныеИтого");
	ОбластьДанныеПоПредприятию = Макет.ПолучитьОбласть("ДанныеПоПредприятию");
		
	ТабДок.Очистить();
	
	Склады = Новый Массив;
	Материалы = Новый Массив;
	Остатки = Новый Массив;
	ИтогСумма = 0;
	ИтогСкладыСумма = Новый Соответствие;
	
	// Получаем склады	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Склады.Ссылка
		|ИЗ
		|	Справочник.Склады КАК Склады";
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДанныеСклада = Новый Структура;
		ДанныеСклада.Вставить("Ссылка",Выборка.Ссылка);
		Склады.Добавить(ДанныеСклада);
	КонецЦикла;
	
	// Получаем средние цены на материалы
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЖурналПроводокОстатки.Субконто1.Ссылка КАК Ссылка,
	               |	СУММА(ЖурналПроводокОстатки.СуммаОстаток) / СУММА(ЖурналПроводокОстатки.КоличествоОстаток) КАК Цена
	               |ИЗ
	               |	РегистрБухгалтерии.ЖурналПроводок.Остатки КАК ЖурналПроводокОстатки
	               |ГДЕ
	               |	ЖурналПроводокОстатки.Счет.Код = ""10""
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЖурналПроводокОстатки.Субконто1,
	               |	ЖурналПроводокОстатки.Субконто1.Ссылка
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Цена УБЫВ";
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДанныеМатериала = Новый Структура;
		ДанныеМатериала.Вставить("Ссылка",Выборка.Ссылка);		
		ДанныеМатериала.Вставить("Цена",Выборка.Цена);
		Материалы.Добавить(ДанныеМатериала);
	КонецЦикла;
	
	// Получаем текущие запасы
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЖурналПроводокОстатки.Субконто1 КАК Материал,
		|	ЖурналПроводокОстатки.Субконто2 КАК Склад,
		|	ЖурналПроводокОстатки.СуммаОстаток,
		|	ЖурналПроводокОстатки.КоличествоОстаток
		|ИЗ
		|	РегистрБухгалтерии.ЖурналПроводок.Остатки(&КонецПериода, , , ) КАК ЖурналПроводокОстатки
		|ГДЕ
		|	ЖурналПроводокОстатки.Счет.Код = ""10""
		|
		|УПОРЯДОЧИТЬ ПО
		|	ЖурналПроводокОстатки.Субконто1.Наименование,
		|	ЖурналПроводокОстатки.Субконто2.Код";
	Запрос.УстановитьПараметр("КонецПериода",ОтчетОбъект.Дата);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Предыдущий = Неопределено;
	ТекущиеДанные = Неопределено;
	Пока Выборка.Следующий() Цикл
		Если Выборка.Материал <> Предыдущий Тогда
			Предыдущий = Выборка.Материал;
			
			Если ТекущиеДанные <> Неопределено Тогда
				Остатки.Добавить(ТекущиеДанные);
			КонецЕсли;
			
			ТекущиеДанные = Новый Структура;
			ТекущиеДанные.Вставить("Материал",Выборка.Материал);
			
			Для Каждого Материал из Материалы Цикл
				Если Материал.Ссылка = Выборка.Материал.Ссылка Тогда
					ТекущиеДанные.Вставить("Цена",Материал.Цена);
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
Для Каждого Материал из Материалы Цикл
	Если Материал.Ссылка = Выборка.Материал.Ссылка Тогда
		Количество = Неопределено;
		Если Не Материал.Свойство("Количество",Количество) Тогда
			Количество = 0;
		КонецЕсли;
		Материал.Вставить("Количество",Количество + Выборка.КоличествоОстаток);
		Прервать;
	КонецЕсли;
КонецЦикла;
		
МатериалНаСкладе = Новый Структура;
МатериалНаСкладе.Вставить("Склад",Выборка.Склад);
МатериалНаСкладе.Вставить("Сумма",Выборка.СуммаОстаток);
МатериалНаСкладе.Вставить("Количество",Выборка.КоличествоОстаток);

МатериалСклады = Неопределено;
Если Не ТекущиеДанные.Свойство("Склады",МатериалСклады) Тогда
	МатериалСклады = Новый Массив;
КонецЕсли;
МатериалСклады.Добавить(МатериалНаСкладе);

ТекущиеДанные.Вставить("Склады",МатериалСклады);
		
		
СкладСумма = ИтогСкладыСумма.Получить(Выборка.Склад.Ссылка);
Если СкладСумма = Неопределено Тогда
	ИтогСкладыСумма.Вставить(Выборка.Склад.Ссылка,Выборка.СуммаОстаток);
Иначе
	ИтогСкладыСумма.Вставить(Выборка.Склад.Ссылка,СкладСумма + Выборка.СуммаОстаток);
КонецЕсли;
		
ИтогСумма = ИтогСумма + Выборка.СуммаОстаток;
	КонецЦикла;
Если ТекущиеДанные <> Неопределено Тогда
	Остатки.Добавить(ТекущиеДанные);
КонецЕсли;
	
	// Строим Документ
ОбластьЗаголовок.Параметры[0] = "Запасы спецодежды на складах предприятия на " + Дата;
ТабДок.Вывести(ОбластьЗаголовок);

ТабДок.Вывести(ОбластьЗаголовокОсновное);	
Для Каждого Склад Из Склады Цикл
	ОбластьЗаголовокСклад.Параметры[0] = Склад.Ссылка.Наименование;
	ТабДок.Присоединить(ОбластьЗаголовокСклад);
КонецЦикла;

Для Каждого Остаток Из Остатки Цикл
	ОбластьДанныеОсновное.Параметры[0] = Остаток.Материал;
	ОбластьДанныеОсновное.Параметры[1] = Остаток.Цена;
	
	ТабДок.Вывести(ОбластьДанныеОсновное);
	
	МатериалСклады = Остаток.Склады;
	
	Для Каждого МатериалСклад Из МатериалСклады Цикл
		ОбластьДанныеСклад.Параметры[0] = МатериалСклад.Количество;
		ОбластьДанныеСклад.Параметры[1] = МатериалСклад.Сумма;
		
		ТабДок.Присоединить(ОбластьДанныеСклад);
	КонецЦикла;
КонецЦикла;

ТабДок.Вывести(ОбластьЗаголовокИтого);
Для Каждого Склад Из Склады Цикл
	ОбластьДанныеИтого.Параметры[0] = ИтогСкладыСумма.Получить(Склад.Ссылка);
	ТабДок.Присоединить(ОбластьДанныеИтого);
КонецЦикла;

ОбластьДанныеПоПредприятию.Параметры[0] = ИтогСумма;
ТабДок.Вывести(ОбластьДанныеПоПредприятию);

	// Инициализируем данные результата
	МатериалыРезультат = Новый Массив();
	ИтогСкладыСумма = Новый Соответствие;
	Для Каждого Материал из Материалы Цикл
		Данные = Новый Структура;
		Данные.Вставить("Материал",Материал.Ссылка);
		Данные.Вставить("Цена",Материал.Цена);
		
		СкладыРезультат = Новый Массив();
		Для Каждого Склад Из Склады Цикл
			Если Склад.Ссылка <> ОтчетОбъект.ЛиквидируемыйСклад.Ссылка Тогда
				ДанныеСклад = Новый Структура;
				ДанныеСклад.Вставить("Склад",Склад.Ссылка);			
				ДанныеСклад.Вставить("Сумма",0);
				СкладыРезультат.Добавить(ДанныеСклад);
			КонецЕсли;
		КонецЦикла;
		ТекущийСклад = СкладыРезультат[0];
		
		Пока Материал.Количество > 0 Цикл
			Количество = 0;
			Если Не ТекущийСклад.Свойство("Количество",Количество) Тогда
				 ТекущийСклад.Вставить("Количество",1);
			Иначе
				ТекущийСклад.Вставить("Количество",Количество + 1);
			КонецЕсли;
			
			Сумма = 0;
			Если Не ТекущийСклад.Свойство("Сумма",Сумма) Тогда
				 ТекущийСклад.Вставить("Сумма",1);
			Иначе
				ТекущийСклад.Вставить("Сумма",Сумма + Материал.Цена);
			КонецЕсли;
			
			СкладСумма = ИтогСкладыСумма.Получить(ТекущийСклад.Склад.Ссылка);
			Если СкладСумма = Неопределено Тогда
				ИтогСкладыСумма.Вставить(ТекущийСклад.Склад.Ссылка,Материал.Цена);
			Иначе
				ИтогСкладыСумма.Вставить(ТекущийСклад.Склад.Ссылка,СкладСумма + Материал.Цена);
			КонецЕсли;
			
			Для Каждого Склад Из СкладыРезультат Цикл
				Если Склад.Сумма < ТекущийСклад.Сумма Тогда
					ТекущийСклад = Склад;
				КонецЕсли;
			КонецЦикла;
			
			Материал.Количество = Материал.Количество - 1;
		КонецЦикла;
		
		Данные.Вставить("Склады",СкладыРезультат);
		
		МатериалыРезультат.Добавить(Данные);
	КонецЦикла;
	
	// Строим Документ
	ОбластьЗаголовок.Параметры[0] = "Предлагаемый вариант размещения спецодежды";
	ТабДок.Вывести(ОбластьЗаголовок);

	ТабДок.Вывести(ОбластьЗаголовокОсновное);	
	Для Каждого Склад Из Склады Цикл
		Если Склад.Ссылка <> ОтчетОбъект.ЛиквидируемыйСклад.Ссылка Тогда
			ОбластьЗаголовокСклад.Параметры[0] = Склад.Ссылка.Наименование;
			ТабДок.Присоединить(ОбластьЗаголовокСклад);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Материал Из МатериалыРезультат Цикл
        ОбластьДанныеОсновное.Параметры[0] = Материал.Материал;
		ОбластьДанныеОсновное.Параметры[1] = Материал.Цена;
		
		ТабДок.Вывести(ОбластьДанныеОсновное);
		
		МатериалСклады = Материал.Склады;
		
		Для Каждого МатериалСклад Из МатериалСклады Цикл
			ОбластьДанныеСклад.Параметры[0] = МатериалСклад.Количество;
			ОбластьДанныеСклад.Параметры[1] = МатериалСклад.Сумма;
			
			ТабДок.Присоединить(ОбластьДанныеСклад);
		КонецЦикла;
	КонецЦикла;
	ТабДок.Вывести(ОбластьЗаголовокИтого);
	Для Каждого Склад Из Склады Цикл
		Если Склад.Ссылка <> ОтчетОбъект.ЛиквидируемыйСклад.Ссылка Тогда
			ОбластьДанныеИтого.Параметры[0] = ИтогСкладыСумма.Получить(Склад.Ссылка);
			ТабДок.Присоединить(ОбластьДанныеИтого);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
