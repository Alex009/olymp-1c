Процедура КнопкаСформироватьНажатие(Кнопка)
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента1;
	
	Макет = ПолучитьМакет("Макет");
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьДанные = Макет.ПолучитьОбласть("Данные");
	ОбластьИтоги = Макет.ПолучитьОбласть("Итоги");
	
	Склады = Новый Соответствие;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЖурналОперацийОбороты.Субконто2,
	               |	ЖурналОперацийОбороты.КорСубконто2,
	               |	СУММА(ЖурналОперацийОбороты.СуммаОборотДт) КАК СуммаОборот
	               |ИЗ
	               |	РегистрБухгалтерии.ЖурналОпераций.Обороты(&ДатаНач, &ДатаКон, , Счет = &Счет, , , , ) КАК ЖурналОперацийОбороты
	               |ГДЕ
	               |	ЖурналОперацийОбороты.Субконто1 = ЖурналОперацийОбороты.КорСубконто1
	               |	И ЖурналОперацийОбороты.Субконто2 <> ЖурналОперацийОбороты.КорСубконто2
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЖурналОперацийОбороты.Субконто2,
	               |	ЖурналОперацийОбороты.КорСубконто2";
	Запрос.УстановитьПараметр("ДатаНач",ДатаНачала);
	Запрос.УстановитьПараметр("ДатаКон",ДатаКонца);
	Запрос.УстановитьПараметр("Счет",ПланыСчетов.Счета.Товары);

	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Склад1 = Выборка.Субконто2;
		Склад2 = Выборка.КорСубконто2;
		
		Связи1 = Склады.Получить(Склад1);
		Связи2 = Склады.Получить(Склад2);
		Если Связи1 = Неопределено Тогда
			Связи1 = Новый Структура;
			Связи1.Вставить("Посещено",Ложь);
			Связи1.Вставить("Связи",Новый Массив);
			Склады.Вставить(Склад1,Связи1);
		КонецЕсли;
		Если Связи2 = Неопределено Тогда
			Связи2 = Новый Структура;
			Связи2.Вставить("Посещено",Ложь);
			Связи2.Вставить("Связи",Новый Массив);
			Склады.Вставить(Склад2,Связи2);
		КонецЕсли;
		
		Связь1 = Неопределено;
		Связь2 = Неопределено;
		
		Для Каждого Связь Из Связи1.Связи Цикл
			Если Связь.Склад = Склад2 Тогда
				Связь1 = Связь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Связь Из Связи2.Связи Цикл
			Если Связь.Склад = Склад1 Тогда
				Связь2 = Связь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если Связь1 = Неопределено Тогда
			Связь1 = Новый Структура;
			Связь1.Вставить("Склад",Склад2);
			Связь1.Вставить("Сумма",0);
			
			Связи1.Связи.Добавить(Связь1);
		КонецЕсли;
		
		Если Связь2 = Неопределено Тогда
			Связь2 = Новый Структура;
			Связь2.Вставить("Склад",Склад1);
			Связь2.Вставить("Сумма",0);
			
			Связи2.Связи.Добавить(Связь2);
		КонецЕсли;
		
		Связь1.Сумма = Связь1.Сумма + Выборка.СуммаОборот;
		Связь2.Сумма = Связь2.Сумма + Выборка.СуммаОборот;
	КонецЦикла;
	
	Если КоличествоГородов > Склады.Количество() Тогда
		КоличествоГородов = Склады.Количество();
	КонецЕсли;
	
	Результат = НайтиПуть(Склады,Неопределено,КоличествоГородов);
	
	ТабДок.Очистить();
	
	ТабДок.Вывести(ОбластьЗаголовок);
	Для Каждого Склад Из Результат.Склады Цикл
		ОбластьДанные.Параметры[0] = Склад.Наименование;
		ТабДок.Вывести(ОбластьДанные);
	КонецЦикла;
	ОбластьИтоги.Параметры[0] = Результат.Сумма;
	ТабДок.Вывести(ОбластьИтоги);
КонецПроцедуры

Функция НайтиПуть(Склады,Корень,ОсталосьШагов)
	ЛучшийПуть = Неопределено;
	ЛучшийВес = 0;
	ЛучшийШаг = Неопределено;
	
	Если ОсталосьШагов = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если Корень = Неопределено Тогда
		Для Каждого Склад Из Склады Цикл
			Склад.Значение.Посещено = Истина;
			Путь = НайтиПуть(Склады,Склад.Ключ,ОсталосьШагов);
			Склад.Значение.Посещено = Ложь;
			
			Если ЛучшийПуть = Неопределено Тогда
				ЛучшийПуть = Путь;
				ЛучшийПуть.Склады.Вставить(0,Склад.Ключ);
			ИначеЕсли Путь <> Неопределено И ЛучшийПуть.Сумма < Путь.Сумма Тогда
				ЛучшийПуть = Путь;
				ЛучшийПуть.Склады.Вставить(0,Склад.Ключ);
			КонецЕсли;
		КонецЦикла;
		
		Возврат ЛучшийПуть;
	Иначе
		СкладСвязи = Склады.Получить(Корень);
		Для Каждого Связь из СкладСвязи.Связи Цикл
			Склад = Склады.Получить(Связь.Склад);
			Если Склад.Посещено Тогда
				Продолжить;
			КонецЕсли;
			
			Склад.Посещено = Истина;		
			Путь = НайтиПуть(Склады,Связь.Склад,ОсталосьШагов - 1);
			Склад.Посещено = Ложь;
			
			Если ЛучшийПуть = Неопределено Тогда
				ЛучшийПуть = Путь;
				ЛучшийВес = Связь.Сумма;
				ЛучшийШаг = Связь.Склад;
			ИначеЕсли Путь <> Неопределено И ЛучшийПуть.Сумма < Путь.Сумма Тогда
				ЛучшийПуть = Путь;
				ЛучшийВес = Связь.Сумма;
				ЛучшийШаг = Связь.Склад;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	СписокСкладов = Новый Массив;
	СуммаОпераций = 0;
	Если ЛучшийПуть <> Неопределено Тогда		
		СписокСкладов.Добавить(ЛучшийШаг);
		СуммаОпераций = ЛучшийВес;
		
		Для Каждого Шаг Из ЛучшийПуть.Склады Цикл
			СписокСкладов.Добавить(Шаг);
		КонецЦикла; 
		СуммаОпераций = СуммаОпераций + ЛучшийПуть.Сумма;
	КонецЕсли;
	
	Путь = Новый Структура;
	Путь.Вставить("Склады",СписокСкладов);
	Путь.Вставить("Сумма",СуммаОпераций);
	
	Возврат Путь;
КонецФункции

Процедура ПриОткрытии()
	КоличествоГородов = 4;
	ДатаНачала = '20080101';
	ДатаКонца = '20080331';
КонецПроцедуры