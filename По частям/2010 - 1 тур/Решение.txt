Процедура КнопкаСформироватьНажатие(Кнопка)
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента1;
	
	Валюта = Новый Массив;
	Товары = Новый Массив;
	Результаты = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	КурсДоллара.Период,
	               |	КурсДоллара.Курс
	               |ИЗ
	               |	РегистрСведений.КурсДоллара КАК КурсДоллара
	               |ГДЕ
	               |	КурсДоллара.Период МЕЖДУ &ДатаНач И &ДатаКон";
	Запрос.УстановитьПараметр("ДатаНач",ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон",ДатаКон);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Запись = Новый Структура;
		Запись.Вставить("Дата",Выборка.Период);
		Запись.Вставить("Курс",Выборка.Курс);
		
		Валюта.Добавить(Запись);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЖурналОперацийДвиженияССубконто.Период,
	               |	ЖурналОперацийДвиженияССубконто.СчетДт.Код КАК СчетДтКод,
	               |	ЖурналОперацийДвиженияССубконто.СубконтоДт1,
	               |	ЖурналОперацийДвиженияССубконто.СчетКт.Код КАК СчетКтКод,
	               |	ЖурналОперацийДвиженияССубконто.СубконтоКт1,
	               |	ЖурналОперацийДвиженияССубконто.Сумма
	               |ИЗ
	               |	РегистрБухгалтерии.ЖурналОпераций.ДвиженияССубконто КАК ЖурналОперацийДвиженияССубконто
	               |ГДЕ
	               |	(ЖурналОперацийДвиженияССубконто.СчетДт = &Счет
	               |			ИЛИ ЖурналОперацийДвиженияССубконто.СчетКт = &Счет)
	               |	И ЖурналОперацийДвиженияССубконто.Период МЕЖДУ &ДатаНач И &ДатаКон";
	Запрос.УстановитьПараметр("Счет",ПланыСчетов.Счета.Товары);
	Запрос.УстановитьПараметр("ДатаНач",ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон",ДатаКон);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Субконто = Неопределено;
		Сумма = 0;
		Если Выборка.СчетДтКод = ПланыСчетов.Счета.Товары.Код Тогда
			Субконто = Выборка.СубконтоДт1;
			Сумма = Выборка.Сумма;
		ИначеЕсли Выборка.СчетКтКод = ПланыСчетов.Счета.Товары.Код Тогда
			Субконто = Выборка.СубконтоКт1;
			Сумма = -Выборка.Сумма;
		КонецЕсли;
		
		Запись = Неопределено;
		Для Каждого Товар Из Товары Цикл
			Если Товар.Ссылка = Субконто Тогда
				Запись = Товар;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если Запись = Неопределено Тогда
			Запись = Новый Структура;
			Запись.Вставить("Ссылка",Субконто);
			
			Цены = Новый Массив;
			Для День = 1 по Валюта.Количество() Цикл
				Цены.Добавить(Сумма);
			КонецЦикла;
			Запись.Вставить("Цены",Цены);
			
			Товары.Добавить(Запись);
			
			РезЗапись = Новый Структура;
			РезЗапись.Вставить("Ссылка",Субконто);
			РезЗапись.Вставить("Дата1",ДатаНач);
			РезЗапись.Вставить("Дата2",ДатаКон);
			РезЗапись.Вставить("Сумма",0);
			Результаты.Добавить(РезЗапись);
		Иначе
			ДеньНач = Окр(((Выборка.Период - ДатаНач) / (60*60*24)),0,0);
			Для День = ДеньНач по Валюта.Количество() - 1 Цикл
				Запись.Цены[День] = Запись.Цены[День] + Сумма;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	Для Ид = 0 По Результаты.ВГраница() Цикл
		ВалСуммаМакс = 0;
		
		Для День = 0 По Валюта.ВГраница() Цикл
			ЦенаНовая = Товары[Ид].Цены[День] / Валюта[День].Курс;
			Товары[Ид].Цены[День] = ЦенаНовая;
			
			Если ЦенаНовая > ВалСуммаМакс Тогда
				ВалСуммаМакс = ЦенаНовая;
			КонецЕсли;
		КонецЦикла;
		
		Начало = Неопределено;
		Конец = Неопределено;
		
		НачалоМакс = 0;
		КонецМакс = 0;
		
		Для День = 0 По Валюта.ВГраница() Цикл
			Если Товары[Ид].Цены[День] = ВалСуммаМакс Тогда
				Если Начало = Неопределено Тогда
					Начало = День;
					Конец = День + 1;
				КонецЕсли;
			Иначе
				Если Начало <> Неопределено Тогда
					Конец = День;
					Если (Конец - Начало) > (КонецМакс - НачалоМакс) Тогда
						НачалоМакс = Начало;
						КонецМакс = Конец;
					КонецЕсли;
					
					Начало = Неопределено;
					Конец = Неопределено;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		Результаты[Ид].Дата1 = ДатаНач + (НачалоМакс * 60*60*24);
		Результаты[Ид].Дата2 = ДатаНач + (КонецМакс * 60*60*24) - 1;
		Результаты[Ид].Сумма = ВалСуммаМакс;
	КонецЦикла;
	
	Макет = ПолучитьМакет("Макет");
	
	ОбластьЗапись = Макет.ПолучитьОбласть("Запись");
	
	ТабДок.Очистить();
	
	Для Каждого Результат Из Результаты Цикл
		ОбластьЗапись.Параметры[0] = Результат.Ссылка;
		ОбластьЗапись.Параметры[1] = Результат.Дата1;
		ОбластьЗапись.Параметры[2] = Результат.Дата2;
		ОбластьЗапись.Параметры[3] = Результат.Сумма;
		
		ТабДок.Вывести(ОбластьЗапись);
	КонецЦикла;	
КонецПроцедуры

Процедура ПриОткрытии()
	ДатаНач = Дата(2009,04,01);
	ДатаКон = Дата(2009,04,30);
КонецПроцедуры
