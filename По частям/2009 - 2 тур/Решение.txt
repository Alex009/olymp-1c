Процедура КнопкаСформироватьНажатие(Кнопка)
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента1;
	
	Макет = ПолучитьМакет("Макет");
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ЖурналПроводокОстатки.Субконто1 КАК Товар
	               |ИЗ
	               |	РегистрБухгалтерии.ЖурналПроводок.Остатки КАК ЖурналПроводокОстатки
	               |ГДЕ
	               |	ЖурналПроводокОстатки.Счет.Код = ""41""
	               |	И ЖурналПроводокОстатки.КоличествоОстаток > 0";
	Выборка = Запрос.Выполнить().Выбрать();
	
	Товары = Новый Массив();
	
	Пока Выборка.Следующий() Цикл			
		Запись = Новый Структура;
		Запись.Вставить("Ссылка",Выборка.Товар.Ссылка);
		Запись.Вставить("НаВитрине",ложь);
			
		Товары.Добавить(Запись);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Движения1.СубконтоКт1 КАК Товар1,
		|	Движения2.СубконтоКт1 КАК Товар2
		|ИЗ
		|	РегистрБухгалтерии.ЖурналПроводок.ДвиженияССубконто КАК Движения1
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.ЖурналПроводок.ДвиженияССубконто КАК Движения2
		|		ПО Движения1.Регистратор = Движения2.Регистратор
		|			И Движения1.СубконтоКт1 <> Движения2.СубконтоКт1
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			Движения.Регистратор КАК Регистратор,
		|			КОЛИЧЕСТВО(Движения.НомерСтроки) КАК КолСтрок
		|		ИЗ
		|			РегистрБухгалтерии.ЖурналПроводок.ДвиженияССубконто КАК Движения
		|		
		|		СГРУППИРОВАТЬ ПО
		|			Движения.Регистратор) КАК ВложенныйЗапрос
		|		ПО Движения1.Регистратор = ВложенныйЗапрос.Регистратор
		|ГДЕ
		|	ВложенныйЗапрос.КолСтрок = 2
		|	И Движения1.НомерСтроки = 1
		|	И Движения2.НомерСтроки = 2";
	Результат = Запрос.Выполнить();

	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы"); 
	ОбластьДетальныхЗаписей = Макет.ПолучитьОбласть("Детали");

	ТабДок.Очистить();
	ТабДок.Вывести(ОбластьШапкаТаблицы);

	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		Товар1 = Неопределено;
		Товар2 = Неопределено;
		Для Каждого Товар Из Товары Цикл
			Если Товар.Ссылка = Выборка.Товар1.Ссылка Тогда
				Товар1 = Товар;
			КонецЕсли;
			Если Товар.Ссылка = Выборка.Товар2.Ссылка Тогда
				Товар2 = Товар;
			КонецЕсли;
		КонецЦикла;
		
		Если Товар1 = Неопределено ИЛИ Товар2 = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если Товар1.НаВитрине ИЛИ Товар2.НаВитрине Тогда
			Продолжить;
		КонецЕсли;
		
		Товар1.НаВитрине = Истина;
		Товар2.НаВитрине = Истина;
		
		ОбластьДетальныхЗаписей.Параметры.Заполнить(Выборка);
		ТабДок.Вывести(ОбластьДетальныхЗаписей);
	КонецЦикла;
	
КонецПроцедуры
