
Процедура КнопкаСформироватьНажатие(Кнопка)
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента;
	
	Макет = ПолучитьМакет("Макет");
	
	ОбластьЗапись = Макет.ПолучитьОбласть("Запись");
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	
	ТабДок.Очистить();
	
	ОсновныеСредства = Новый Массив();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПроводкиДвиженияССубконто.СчетДт,
	               |	ПроводкиДвиженияССубконто.СубконтоДт1,
	               |	ПроводкиДвиженияССубконто.СчетКт,
	               |	ПроводкиДвиженияССубконто.СубконтоКт1,
	               |	ПроводкиДвиженияССубконто.Сумма,
	               |	ОсновныеСредства.СПИ
	               |ИЗ
	               |	РегистрБухгалтерии.Проводки.ДвиженияССубконто(, &Дата, , , ) КАК ПроводкиДвиженияССубконто
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОсновныеСредства КАК ОсновныеСредства
	               |		ПО ПроводкиДвиженияССубконто.СубконтоКт1 = ОсновныеСредства.Ссылка";
	Запрос.УстановитьПараметр("Дата",Дата);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		// проверяем есть ли уже запись с субконто
		Субконто = Неопределено;
		Стоимость = 0;
		Выплачено = 0;
		Осталось = 0;
		Если Выборка.СчетДт.Код = "01" Тогда
			Субконто = Выборка.СубконтоДт1;
			Стоимость = Выборка.Сумма;
		ИначеЕсли Выборка.СчетКт.Код = "02" Тогда
			Субконто = Выборка.СубконтоКт1;
			Выплачено = Выборка.Сумма;
			Осталось = Выборка.СПИ;
		КонецЕсли;
		
		Запись = Неопределено;
		Для Каждого ОС Из ОсновныеСредства Цикл
			Если ОС.Субконто = Субконто Тогда
				Запись = ОС;
			КонецЕсли;
		КонецЦикла;
		
		Если Запись = Неопределено Тогда
			Запись = Новый Структура;
			Запись.Вставить("Субконто",Субконто);
			Запись.Вставить("Стоимость",Стоимость);
			Запись.Вставить("Выплачено",Выплачено);
			Запись.Вставить("Осталось",Осталось);
			
			ОсновныеСредства.Добавить(Запись);
		Иначе
			Если Стоимость <> 0 Тогда
				Запись.Стоимость = Стоимость;
			КонецЕсли;
			Если Выплачено <> 0 Тогда
				Запись.Выплачено = Выплачено;
			КонецЕсли;
			Если Осталось <> 0 Тогда
				Запись.Осталось = Осталось;
			КонецЕсли;
		КонецЕсли; 
	КонецЦикла;
	
	Для Каждого ОС Из ОсновныеСредства Цикл
		ОсталосьВыплатить = ОС.Стоимость - ОС.Выплачено;
		СуммаЛет = 0;
		Осталось = ОС.Осталось; 
		ГодКонца = Год(Дата);
		МесяцКонца = Месяц(Дата);
		Пока Осталось > 12 Цикл 
			Осталось = Осталось - 12;
			ГодКонца = ГодКонца + 1;
		КонецЦикла; 
		Если Осталось > 0 Тогда
			МесяцКонца = МесяцКонца + Осталось;
			Если МесяцКонца > 12 Тогда
				МесяцКонца = МесяцКонца - 12;
				ГодКонца = ГодКонца + 1;
			КонецЕсли;
		КонецЕсли;
		
		Осталось = ОС.Осталось;
		Если Осталось > МесяцКонца Тогда
			СуммаЛет = (МесяцКонца/12); // начисления амортизации за последний календарный год
		    Осталось = Осталось - МесяцКонца;
		Иначе
			СуммаЛет = Осталось/12; // оставшаяся амортизация вся приходится на текущий календарный год
			Осталось = 0;
		КонецЕсли;
		
		ТекГодКоэф = 1;
		Пока Осталось > 0 Цикл
			// сумма за этот год
			Сумма = ((12-МесяцКонца)*ТекГодКоэф + МесяцКонца*(ТекГодКоэф+1))/12;
			// если осталось больше года - берем всю сумму, иначе - часть суммы (в зависимости от оставшихся месяцев)
			Если Осталось > 12 Тогда
				СуммаЛет = СуммаЛет + Сумма;
				Осталось = Осталось - 12;
			Иначе
				СуммаЛет = СуммаЛет + Сумма*(Осталось/12);
				Осталось = 0;
			КонецЕсли;
			
			ТекГодКоэф = ТекГодКоэф + 1;
		КонецЦикла;		
		
		СуммаЧисел = Окр((ОС.Стоимость*СуммаЛет)/ОсталосьВыплатить,0);
		
		Дескр = 1 + 4*СуммаЧисел*2;
		
		Если Sqrt(Дескр) <> Цел(Sqrt(Дескр)) Тогда
			ОС.Вставить("Годы","н/о");
			ОС.Вставить("МесяцНачала","н/о");
			ОС.Вставить("ГодНачала","н/о");
		Иначе
			Годы1 = (-1 + Sqrt(Дескр))/2;
			Годы2 = (-1 - Sqrt(Дескр))/2;

			Годы = 0;
			Если Годы1 > 0 Тогда
				Годы = Годы1;
			ИначеЕсли Годы2 > 0 Тогда
				Годы = Годы2;
			КонецЕсли;  
			
			ОС.Вставить("Годы",Годы); 			
			ОС.Вставить("МесяцНачала",МесяцКонца);
			ОС.Вставить("ГодНачала",ГодКонца - Годы);
		КонецЕсли;	
	КонецЦикла;
	
	ТабДок.Вывести(ОбластьЗаголовок);
	Для Каждого ОС Из ОсновныеСредства Цикл
		ОбластьЗапись.Параметры[0] = ОС.Субконто;
		ОбластьЗапись.Параметры[1] = ОС.Стоимость;
		ОбластьЗапись.Параметры[2] = ОС.Выплачено;
		ОбластьЗапись.Параметры[3] = ОС.Осталось;
		ОбластьЗапись.Параметры[4] = ОС.МесяцНачала;
		ОбластьЗапись.Параметры[5] = ОС.ГодНачала;
		ОбластьЗапись.Параметры[6] = ОС.Годы;
		
		ТабДок.Вывести(ОбластьЗапись);
	КонецЦикла;
КонецПроцедуры

Процедура ПриОткрытии()
	Дата = Дата(2010,4,1);
КонецПроцедуры
